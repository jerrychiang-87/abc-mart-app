<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
  <title>ABC-MART App 下載 / 開啟</title>
  <meta name="robots" content="noindex,nofollow" />
  <style>
    :root { --border:#e5e7eb; --muted:#666; --note:#888; }
    body{
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC",Arial,sans-serif;
      background:#fff; color:#222; margin:0; padding:40px; text-align:center; line-height:1.6;
    }
    h1{ font-size:22px; margin:0 0 8px }
    p{ margin:0 0 16px; font-size:15px; color:var(--muted) }
    .btn{ display:inline-block; margin:6px; padding:10px 16px; border:1px solid var(--border);
      border-radius:10px; text-decoration:none; color:#000; transition:.2s }
    .btn:hover{ background:#000; color:#fff }
    .warn{ display:none; max-width:760px; margin:14px auto 0; font-size:14px; color:#444;
      background:#fff7e6; border:1px solid #ffe1a3; padding:10px 12px; border-radius:10px; text-align:left }
    .note{ font-size:13px; color:var(--note); margin-top:10px }
  </style>
</head>
<body>
  <h1>ABC-MART App 下載 / 開啟</h1>
  <p>正在嘗試為你開啟 App；若未成功，請改用下方按鈕。</p>

  <a id="btnApp" class="btn">嘗試開啟 App</a>
  <a id="btnWeb" class="btn">改用官網查看</a>
  <a id="btnStore" class="btn">前往商店安裝 App</a>

  <div id="iabWarn" class="warn">
    偵測到你可能使用社群 App 的內建瀏覽器（如 IG、FB、微信），可能會阻擋自動開啟 App。<br>
    請點右上角「⋯」→「在瀏覽器中開啟」，回到此頁再嘗試一次。
  </div>

  <p class="note">可在網址帶參數：<code>?deep=</code>（App Deep Link / UL）、<code>&web=</code>（備援網頁）、<code>&pkg=</code>（Android 套件名）。</p>

  <script>
  (function(){
    // ---- UA 與平台偵測 ----
    const ua = navigator.userAgent || '';
    const isAndroid = /Android/i.test(ua);
    const isIOS = /iPhone|iPad|iPod/i.test(ua) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
    const isWeChat = /MicroMessenger/i.test(ua);
    const isFB = /FBAN|FBAV|FB_IAB/i.test(ua);
    const isIG = /Instagram/i.test(ua);
    const isIAB = isWeChat || isFB || isIG;

    // ---- 參數 ----
    const qs  = new URLSearchParams(location.search);
    const deep = qs.get('deep') || '';           // 例：abcmart://product/123 或 https://UL
    const web  = qs.get('web')  || '';           // 例：https://www.abc-mart.com.tw/product/123
    const pkg  = qs.get('pkg')  || '';           // 例：com.abcmart.android

    // ---- 備援（若未帶參數時使用，可改成你要的落地頁）----
    const STORE = {
      ios: "https://apps.apple.com/us/app/abc-mart/id1527718084",
      android: "https://play.google.com/store/apps/details?id=com.abcmart.android",
      desktop: "https://www.abc-mart.com.tw/"
    };

    // ---- DOM 綁定 ----
    const btnApp   = document.getElementById('btnApp');
    const btnWeb   = document.getElementById('btnWeb');
    const btnStore = document.getElementById('btnStore');
    const iabWarn  = document.getElementById('iabWarn');

    if (iabWarn && isIAB) iabWarn.style.display = 'block';
    if (btnWeb)   btnWeb.onclick   = () => go(web || STORE.desktop);
    if (btnStore) btnStore.onclick = () => go(isAndroid ? STORE.android : (isIOS ? STORE.ios : STORE.desktop));
    if (btnApp)   btnApp.onclick   = tryOpen;

    // ---- 進站自動嘗試 ----
    if (deep || web) {
      tryOpen();
    } else {
      // 舊行為：沒帶參數 → 依裝置導商店/官網（1 秒後）
      setTimeout(() => go(isAndroid ? STORE.android : (isIOS ? STORE.ios : STORE.desktop)), 1000);
    }

    // ---- 主流程 ----
    function tryOpen() {
      if (!deep) { go(web || STORE.desktop); return; }

      if (isIOS) {
        // 若 deep 是 Universal Link（https），交由系統判斷是否打開 App
        if (/^https:\/\//i.test(deep)) { go(deep); return; }
        // 否則：scheme + visibility 偵測 + 計時回落
        openWithVisibilityFallback(deep, web || STORE.ios, 1000);
        return;
      }

      if (isAndroid) {
        if (pkg) {
          // 先使用 intent://（成功率高）
          go(toIntentUrl(deep, pkg, web || STORE.android));
          // 少數瀏覽器對 intent 無感 → 0.5s 後補 scheme，再 0.9s 後回落
          setTimeout(() => openWithTimer(deep, web || STORE.android, 900), 500);
        } else {
          // 沒 pkg：scheme + 計時回落
          openWithTimer(deep, web || STORE.android, 900);
        }
        return;
      }

      // 其他平台（桌面等）
      go(web || STORE.desktop);
    }

    // ---- iOS：visibility 偵測是否切到背景（成功開啟 App）----
    function openWithVisibilityFallback(appUrl, fallbackUrl, timeout){
      let done = false;
      const t = setTimeout(() => { if (!done) go(fallbackUrl); }, timeout);
      const onVis = () => {
        if (document.hidden) { done = true; clearTimeout(t); cleanup(); }
      };
      const cleanup = () => document.removeEventListener('visibilitychange', onVis);
      document.addEventListener('visibilitychange', onVis);

      // iOS 近年版以 location 觸發較穩
      location.href = appUrl;

      // 安全網：3 秒後移除監聽
      setTimeout(cleanup, 3000);
    }

    // ---- 通用：隱形 iframe 觸發 + 計時回落（Android 與舊 iOS 相容）----
    function openWithTimer(appUrl, fallbackUrl, timeout){
      const start = Date.now();
      const iframe = document.createElement('iframe');
      iframe.style.display = 'none';
      iframe.src = appUrl;
      document.body.appendChild(iframe);
      setTimeout(() => {
        if (Date.now() - start < timeout + 120) go(fallbackUrl);
      }, timeout);
    }

    // ---- Android intent:// 拼接 ----
    function toIntentUrl(deep, pkg, fallback){
      const scheme = deep.split('://')[0];
      const rest = deep.split('://')[1] || '';
      return `intent://${rest}#Intent;scheme=${scheme};package=${pkg};S.browser_fallback_url=${encodeURIComponent(fallback)};end`;
    }

    // ---- 安全導向 ----
    function go(url){ if (url) location.href = url; }
  })();
  </script>
</body>
</html>
